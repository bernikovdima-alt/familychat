<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ (Debug)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; height: 100vh; overflow: hidden; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #local-video { width: 100px; height: 150px; bottom: 20px; right: 20px; position: absolute; z-index: 2; border: 2px solid white; border-radius: 10px; background: #222; }
        
        .ui-container { z-index: 10; position: absolute; text-align: center; width: 90%; max-width: 400px; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 20px; backdrop-filter: blur(5px); }
        
        .btn { background: #25D366; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 30px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; display: none; }
        
        #error-log { color: #ff5555; font-size: 12px; margin-top: 15px; white-space: pre-wrap; text-align: left; background: rgba(0,0,0,0.5); padding: 5px; display: none; }
        #status-text { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline></video>

    <div class="ui-container">
        <div id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</div>
        <button id="call-btn" class="btn" onclick="shareLink()">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ</button>
        <div id="error-log"></div>
    </div>

    <script>
        // --- –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω ---
        function logError(msg) {
            const errDiv = document.getElementById('error-log');
            errDiv.style.display = 'block';
            errDiv.innerHTML += "‚ö†Ô∏è " + msg + "<br>";
            console.error(msg);
            document.getElementById('status-text').innerText = "–û—à–∏–±–∫–∞!";
        }

        function setStatus(msg) {
            document.getElementById('status-text').innerText = msg;
        }

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let peer;
        let localStream;

        // 1. –°—Ç–∞—Ä—Ç
        async function init() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            if (typeof Peer === 'undefined') {
                logError("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ PeerJS –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ AdBlock.");
                return;
            }

            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            try {
                setStatus("–í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É...");
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
            } catch (err) {
                logError("–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω! –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
                return;
            }

            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏
            setStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º...");
            
            // –°–æ–∑–¥–∞–µ–º Peer –æ–±—ä–µ–∫—Ç
            try {
                peer = new Peer({
                    debug: 2,
                    config: {
                        iceServers: [
                            { url: 'stun:stun.l.google.com:19302' },
                            { url: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
            } catch (e) {
                logError("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Peer: " + e);
            }

            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

            // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
            peer.on('open', (id) => {
                console.log('My ID:', id);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–≤–æ–Ω–∏–º –º—ã –∏–ª–∏ –∂–¥–µ–º –∑–≤–æ–Ω–∫–∞
                const urlParams = new URLSearchParams(window.location.search);
                const targetId = urlParams.get('id');

                if (targetId) {
                    // –ú–´ - –ú–ê–ú–ê (–ü—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ)
                    setStatus("–ó–≤–æ–Ω–∏–º —Å—ã–Ω—É...");
                    const call = peer.call(targetId, localStream);
                    handleCall(call);
                } else {
                    // –ú–´ - –°–´–ù (–°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É)
                    setStatus("–ì–æ—Ç–æ–≤–æ! –ñ–º–∏ –∫–Ω–æ–ø–∫—É.");
                    const btn = document.getElementById('call-btn');
                    btn.style.display = 'block';
                    
                    // –§—É–Ω–∫—Ü–∏—è –∫–Ω–æ–ø–∫–∏
                    window.shareLink = () => {
                        const link = window.location.href.split('?')[0] + '?id=' + id;
                        if (navigator.share) {
                            navigator.share({ title: '–í–∏–¥–µ–æ—á–∞—Ç', url: link });
                        } else {
                            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:", link);
                        }
                    };
                }
            });

            // –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ PeerJS
            peer.on('error', (err) => {
                let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                if (err.type === 'browser-incompatible') errorMsg = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC";
                if (err.type === 'disconnected') errorMsg = "–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º";
                if (err.type === 'network') errorMsg = "–ë—Ä–∞–Ω–¥–º–∞—É—ç—Ä –∏–ª–∏ —Ä–æ—É—Ç–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–≤–æ–Ω–∫–∏";
                if (err.type === 'unavailable-id') errorMsg = "–≠—Ç–æ—Ç ID —É–∂–µ –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–µ–Ω";
                
                logError(errorMsg + " (" + err.type + ")");
            });

            // –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
            peer.on('call', (call) => {
                if (confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                    setStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");
                    call.answer(localStream);
                    handleCall(call);
                }
            });
        }

        // –õ–æ–≥–∏–∫–∞ —Å–∞–º–æ–≥–æ –∑–≤–æ–Ω–∫–∞
        function handleCall(call) {
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
                document.querySelector('.ui-container').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ
            });
            call.on('close', () => alert("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            call.on('error', (e) => logError("–û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞: " + e));
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º
        init();

    </script>
</body>
</html>
