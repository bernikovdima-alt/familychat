<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background: #0f0f0f; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* –í–∏–¥–µ–æ –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        #remote-video {
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            position: absolute; 
            z-index: 1;
        }

        /* –ú–æ–µ –º–∞–ª–µ–Ω—å–∫–æ–µ –≤–∏–¥–µ–æ */
        #local-video {
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: 100px; 
            height: 150px; 
            background: #333; 
            border-radius: 10px; 
            border: 2px solid white; 
            z-index: 2; 
            object-fit: cover;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∏ —Å—Ç–∞—Ç—É—Å –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .overlay {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 10; 
            text-align: center;
            width: 80%;
        }

        .btn {
            background: #25D366; /* –¶–≤–µ—Ç WhatsApp */
            color: white; 
            padding: 20px 40px; 
            border: none; 
            border-radius: 50px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            width: 100%;
        }

        #status {
            color: white; 
            background: rgba(0,0,0,0.7); 
            padding: 10px; 
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline></video>

    <div class="overlay">
        <div id="status">–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...</div>
        <button class="btn" id="share-btn" onclick="shareLink()">üìû –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –º–∞–º–µ</button>
    </div>

    <script>
        let localStream;
        let peer;

        // 1. –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
        async function start() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ç–∏...";
                initPeer();
            } catch (err) {
                document.getElementById('status').innerText = "–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã! –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.";
            }
        }

        // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ PeerJS
        function initPeer() {
            peer = new Peer(null, {
                debug: 2,
                config: {
                    'iceServers': [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å—Å—ã–ª–∫–µ ID —Ç–æ–≥–æ, –∫–æ–º—É –∑–≤–æ–Ω–∏–º
                const urlParams = new URLSearchParams(window.location.search);
                const callId = urlParams.get('call');

                if (callId) {
                    // –ï–°–õ–ò –ú–´ –ú–ê–ú–ê (–ø—Ä–æ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ) -> –ó–≤–æ–Ω–∏–º —Å—Ä–∞–∑—É
                    document.getElementById('status').innerText = "–ó–≤–æ–Ω–∏–º...";
                    const call = peer.call(callId, localStream);
                    handleCall(call);
                } else {
                    // –ï–°–õ–ò –ú–´ –°–û–ó–î–ê–¢–ï–õ–¨ -> –ñ–¥–µ–º –∑–≤–æ–Ω–∫–∞
                    document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤–æ –∫ –∑–≤–æ–Ω–∫—É!";
                    document.getElementById('share-btn').style.display = 'block';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    const currentUrl = window.location.href.split('?')[0];
                    const link = `${currentUrl}?call=${id}`;
                    
                    document.getElementById('share-btn').onclick = () => {
                        if (navigator.share) {
                            navigator.share({ title: '–ó–≤–æ–Ω–æ–∫', url: link });
                        } else {
                            prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:", link);
                        }
                    };
                }
            });

            // –ö–æ–≥–¥–∞ –Ω–∞–º –∑–≤–æ–Ω—è—Ç (–æ—Ç–≤–µ—Ç)
            peer.on('call', (call) => {
                if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫! –û—Ç–≤–µ—Ç–∏—Ç—å?")) {
                    call.answer(localStream);
                    handleCall(call);
                }
            });
        }

        // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function handleCall(call) {
            document.getElementById('status').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
            document.getElementById('share-btn').style.display = 'none';
            
            call.on('stream', (remoteStream) => {
                document.getElementById('status').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å–∏
                const video = document.getElementById('remote-video');
                video.srcObject = remoteStream;
                video.play().catch(e => console.log(e));
            });
            
            call.on('close', () => alert("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            call.on('error', () => alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"));
        }

        start();
    </script>
</body>
</html>
