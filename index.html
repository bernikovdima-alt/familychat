<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–∏–¥–µ–æ—á–∞—Ç (–§–∏–Ω–∞–ª)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            margin: 0; background: #121212; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; 
        }
        
        /* –í–∏–¥–µ–æ */
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #local-video { 
            width: 100px; height: 150px; position: absolute; bottom: 20px; right: 20px; z-index: 2; 
            border: 2px solid white; border-radius: 12px; background: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* –ú–µ–Ω—é –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .menu { 
            position: absolute; z-index: 10; background: rgba(30, 30, 30, 0.9); padding: 30px; 
            border-radius: 20px; text-align: center; width: 85%; max-width: 350px; backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        h2 { margin: 0 0 15px 0; font-size: 20px; }
        p { color: #aaa; margin-bottom: 20px; font-size: 14px; }
        
        .btn { 
            background: #25D366; color: white; border: none; padding: 15px 0; width: 100%; 
            font-size: 16px; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.2s;
            margin-bottom: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-retry { background: #e74c3c; } /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ */

        #status-log { font-size: 12px; color: #f1c40f; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body>

    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline></video>

    <div class="menu" id="menu">
        <h2 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="desc">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –≤–∏–¥–µ–æ—Å–≤—è–∑–∏</p>
        
        <button id="call-btn" class="btn" style="display:none;" onclick="sendLink()">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ú–∞–º–µ</button>
        <button id="retry-btn" class="btn btn-retry" style="display:none;" onclick="location.reload()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        
        <div id="status-log"></div>
    </div>

    <script>
        let peer;
        let localStream;
        let myId;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID –≤—Ä—É—á–Ω—É—é (–∏–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞)
        function generateId() {
            return 'user-' + Math.random().toString(36).substr(2, 9);
        }

        async function startApp() {
            log("–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...");
            
            // 1. –ö–∞–º–µ—Ä–∞
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
                document.getElementById('local-video').srcObject = localStream;
            } catch (err) {
                showError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ! –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
                return;
            }

            log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –æ–±–ª–∞–∫–æ–º...");

            // 2. –°–æ–∑–¥–∞–µ–º Peer —Å –ñ–ï–°–¢–ö–ò–ú–ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ—Ä—Ç–∞ 443 (—ç—Ç–æ –ª–µ—á–∏—Ç server-error)
            peer = new Peer(generateId(), {
                debug: 2,
                secure: true, 
                host: '0.peerjs.com',
                port: 443,
                config: {
                    iceServers: [
                        { url: 'stun:stun.l.google.com:19302' },
                        { url: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            // 3. –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            peer.on('open', (id) => {
                myId = id;
                log("–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –í–∞—à ID: " + id);
                
                const urlParams = new URLSearchParams(window.location.search);
                const targetId = urlParams.get('call_id');

                if (targetId) {
                    // –ú—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ -> –ó–í–û–ù–ò–ú
                    document.getElementById('title').innerText = "–ó–≤–æ–Ω–∏–º...";
                    document.getElementById('desc').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...";
                    const call = peer.call(targetId, localStream);
                    handleCall(call);
                } else {
                    // –ú—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É -> –ñ–î–ï–ú
                    document.getElementById('title').innerText = "–ì–æ—Ç–æ–≤–æ –∫ –∑–≤–æ–Ω–∫—É";
                    document.getElementById('desc').innerText = "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É";
                    document.getElementById('call-btn').style.display = 'block';
                }
            });

            // 4. –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–¢–æ, —á—Ç–æ –±—ã–ª–æ —É –≤–∞—Å)
            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'server-error' || err.type === 'network') {
                    showError("–°–µ—Ä–≤–µ—Ä —Å–≤—è–∑–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.");
                } else if (err.type === 'unavailable-id') {
                    showError("ID –∑–∞–Ω—è—Ç, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º...");
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showError("–û—à–∏–±–∫–∞: " + err.type);
                }
            });

            // 5. –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
            peer.on('call', (call) => {
                if(confirm("–í–∞–º –∑–≤–æ–Ω—è—Ç! –û—Ç–≤–µ—Ç–∏—Ç—å —Å –≤–∏–¥–µ–æ?")) {
                    call.answer(localStream);
                    handleCall(call);
                }
            });
        }

        function handleCall(call) {
            document.getElementById('menu').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
            
            call.on('stream', (remoteStream) => {
                const video = document.getElementById('remote-video');
                video.srcObject = remoteStream;
                video.play().catch(e => console.log(e));
            });
            
            call.on('close', () => alert("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            call.on('error', () => alert("–°—Ä—ã–≤ —Å–≤—è–∑–∏"));
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏
        function sendLink() {
            const link = window.location.href.split('?')[0] + '?call_id=' + myId;
            if (navigator.share) {
                navigator.share({ title: '–í–∏–¥–µ–æ—á–∞—Ç', url: link });
            } else {
                prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:", link);
            }
        }

        function log(text) {
            document.getElementById('status-log').innerText = text;
        }

        function showError(text) {
            document.getElementById('title').innerText = "–£–ø—Å!";
            document.getElementById('desc').innerText = text;
            document.getElementById('desc').style.color = "#ff5555";
            document.getElementById('call-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å"
        }

        // –ó–∞–ø—É—Å–∫
        startApp();
    </script>
</body>
</html>
